services:
  # Asciinema server for terminal session recording/streaming
  asciinema-server:
    build:
      context: ./asciinema-server
      dockerfile: Dockerfile
    container_name: asciinema-server
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://asciinema:asciinema@postgres:5432/asciinema
      - SECRET_KEY_BASE=${SECRET_KEY_BASE:-change-me-in-production}
      - RAILS_ENV=production
    depends_on:
      - postgres
    volumes:
      - asciinema-data:/app/storage
    networks:
      - agent-network

  # PostgreSQL for asciinema server
  postgres:
    image: postgres:15-alpine
    container_name: asciinema-postgres
    environment:
      - POSTGRES_USER=asciinema
      - POSTGRES_PASSWORD=asciinema
      - POSTGRES_DB=asciinema
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - agent-network

  # MCP messaging server
  mcp-server:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile
    container_name: mcp-server
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=sqlite:///app/data/messages.db
      - PORT=8080
    volumes:
      - mcp-data:/app/data
    networks:
      - agent-network

  # Backend API server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-api
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - MCP_SERVER_URL=http://mcp-server:8080
      - ASCIINEMA_SERVER_URL=http://asciinema-server:3000
    depends_on:
      - mcp-server
      - asciinema-server
    networks:
      - agent-network

  # Agent containers (will be created dynamically)
  # Example agent container
  agent-claude:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: agent-claude
    labels:
      - "agent.name=claude"
      - "agent.type=claude"
    environment:
      - AGENT_NAME=claude
      - AGENT_TYPE=claude
      - MCP_SERVER_URL=http://mcp-server:8080
      - ASCIINEMA_SERVER_URL=http://asciinema-server:3000
    volumes:
      - agent-claude-workspace:/workspace
    depends_on:
      - mcp-server
      - asciinema-server
    networks:
      - agent-network
    profiles:
      - agents

  agent-codex:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: agent-codex
    labels:
      - "agent.name=codex"
      - "agent.type=codex"
    environment:
      - AGENT_NAME=codex
      - AGENT_TYPE=codex
      - MCP_SERVER_URL=http://mcp-server:8080
      - ASCIINEMA_SERVER_URL=http://asciinema-server:3000
    volumes:
      - agent-codex-workspace:/workspace
    depends_on:
      - mcp-server
      - asciinema-server
    networks:
      - agent-network
    profiles:
      - agents

  # Frontend dashboard
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3001
      - NEXT_PUBLIC_MCP_WS_URL=ws://localhost:8080
      - NEXT_PUBLIC_ASCIINEMA_URL=http://localhost:3000
    depends_on:
      - backend
      - mcp-server
    networks:
      - agent-network

volumes:
  postgres-data:
  asciinema-data:
  mcp-data:
  agent-claude-workspace:
  agent-codex-workspace:

networks:
  agent-network:
    driver: bridge

